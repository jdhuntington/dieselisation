#!/usr/bin/env ruby
require File.dirname(__FILE__) + '/../config/environment'
require 'scenario_runner'

order, ignore, *steps = File.read(ARGV.first).split("\n")
players = order.split(/:\s*/).last.split(/,\s*/).map do |username|
  User.find_or_create_by_username(username)
end


$g = Game.create!({ :owner  => players.first,
                    :name   => "#{File.basename(ARGV.first)} - #{Time.new.to_s}",
                    :status => 'new' })


players[1 .. -1].each { |player| $g.add_player player }
$g.start_without_shuffle!


ScenarioRunner::Formatter.init File.basename(ARGV.first)
begin
  steps.each do |step|
    if step =~ /^\*\s*(.*)\s==\s(.*)$/
      ScenarioRunner::Assertions.assert $1, $2
    else
      ScenarioRunner.turn step
    end
  end
ensure
  ScenarioRunner::Formatter.terminate
end
